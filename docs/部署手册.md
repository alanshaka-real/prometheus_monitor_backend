# 部署手册

## 目录

- [环境要求](#环境要求)
- [方式一：直接部署](#方式一直接部署)
- [方式二：Docker 部署](#方式二docker-部署)
- [前后端联合部署](#前后端联合部署)
- [Nginx 反向代理配置](#nginx-反向代理配置)
- [生产环境配置建议](#生产环境配置建议)
- [常见问题](#常见问题)

---

## 环境要求

| 软件 | 最低版本 | 推荐版本 | 说明 |
|------|----------|----------|------|
| JDK | 17 | 17 LTS | 仅支持 Java 17+ |
| Maven | 3.6 | 3.9+ | 构建工具 |
| MySQL | 8.0 | 8.0+ | 主数据库 |
| Prometheus | 2.x | 最新 | 监控数据源（可选） |
| Node.js | 20.19 | 20.x LTS | 前端构建（联合部署时需要） |

---

## 方式一：直接部署

### 1. 初始化数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE prometheus_monitor DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;

# 导入表结构和种子数据
USE prometheus_monitor;
SOURCE /path/to/prometheus_monitor_backend/src/main/resources/db/schema.sql;

# （可选）导入 PromQL 模板数据
SOURCE /path/to/prometheus_monitor_backend/src/main/resources/db/migration/migration_promql_templates.sql;
```

### 2. 修改生产配置

编辑 `src/main/resources/application-prod.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://your-db-host:3306/prometheus_monitor?useUnicode=true&characterEncoding=utf-8&useSSL=true&serverTimezone=Asia/Shanghai
    username: prometheus_user
    password: your_secure_password

jwt:
  secret: your-production-jwt-secret-key-at-least-64-characters-long

prometheus:
  default-url: http://your-prometheus-host:9090

distribute:
  software-path: /opt/prometheus-monitor/software
  encryption-key: your-aes256-encryption-key-32ch!
```

### 3. 打包

```bash
cd prometheus_monitor_backend
mvn clean package -DskipTests
```

### 4. 启动

```bash
# 前台运行
java -jar target/prometheus-monitor-1.0.0.jar --spring.profiles.active=prod

# 后台运行
nohup java -jar target/prometheus-monitor-1.0.0.jar \
  --spring.profiles.active=prod \
  -Xms512m -Xmx1024m \
  > /var/log/prometheus-monitor/app.log 2>&1 &
```

### 5. 使用 systemd 管理（推荐）

创建 `/etc/systemd/system/prometheus-monitor.service`：

```ini
[Unit]
Description=Prometheus Monitor Backend
After=network.target mysql.service

[Service]
Type=simple
User=prometheus-monitor
WorkingDirectory=/opt/prometheus-monitor
ExecStart=/usr/bin/java -Xms512m -Xmx1024m -jar prometheus-monitor-1.0.0.jar --spring.profiles.active=prod
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable prometheus-monitor
sudo systemctl start prometheus-monitor
```

---

## 方式二：Docker 部署

### Dockerfile 示例

```dockerfile
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY target/prometheus-monitor-1.0.0.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-Xms512m", "-Xmx1024m", "-jar", "app.jar"]
```

### 构建 & 运行

```bash
# 构建
mvn clean package -DskipTests
docker build -t prometheus-monitor-backend:latest .

# 运行
docker run -d \
  --name prometheus-monitor-backend \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e SPRING_DATASOURCE_URL="jdbc:mysql://host.docker.internal:3306/prometheus_monitor" \
  -e SPRING_DATASOURCE_PASSWORD=your_password \
  -e JWT_SECRET=your-jwt-secret \
  -v /opt/prometheus-soft:/app/software \
  prometheus-monitor-backend:latest
```

### docker-compose 示例

```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: prometheus_monitor
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./src/main/resources/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql

  backend:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/prometheus_monitor?useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_PASSWORD: root

volumes:
  mysql-data:
```

---

## 前后端联合部署

### 方案：Nginx 托管前端 + 反向代理后端

```bash
# 1. 构建前端
cd prometheus_monitor
pnpm install && pnpm build

# 2. 构建后端
cd prometheus_monitor_backend
mvn clean package -DskipTests

# 3. 部署
# 前端产物 → /var/www/prometheus-monitor/
cp -r prometheus_monitor/dist/* /var/www/prometheus-monitor/

# 后端 JAR → /opt/prometheus-monitor/
cp prometheus_monitor_backend/target/prometheus-monitor-1.0.0.jar /opt/prometheus-monitor/
```

---

## Nginx 反向代理配置

```nginx
server {
    listen 80;
    server_name monitor.example.com;

    # 前端静态文件
    root /var/www/prometheus-monitor;
    index index.html;

    # Vue Router history 模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket 代理
    location /ws/ {
        proxy_pass http://127.0.0.1:8080/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
    }

    # Gzip 压缩
    gzip on;
    gzip_types text/plain application/javascript text/css application/json;
    gzip_min_length 1024;
}
```

---

## 生产环境配置建议

### 安全

- [ ] 修改 JWT Secret 为随机长字符串（>=64 字符）
- [ ] 修改 AES256 加密密钥
- [ ] 修改默认数据库密码
- [ ] 使用 HTTPS（通过 Nginx 配置 SSL）
- [ ] 限制 API 文档访问（生产环境关闭 Knife4j）

### 性能

- [ ] JVM 堆内存建议 512MB ~ 2GB
- [ ] MySQL 连接池 max-pool-size 根据并发调整
- [ ] 开启 Nginx Gzip 压缩

### 监控

- [ ] 配置日志轮转（logback 已内置按日滚动）
- [ ] 配置 JVM 监控（可接入 Prometheus JMX Exporter）

---

## 常见问题

### Q: 启动报错 `Communications link failure`

MySQL 连接失败，检查：
1. MySQL 服务是否启动
2. 数据库 URL、用户名、密码是否正确
3. MySQL 是否允许远程连接

### Q: 前端请求 404

确保 Nginx 配置了 `try_files $uri $uri/ /index.html;`，支持 Vue Router history 模式。

### Q: WebSocket 连接失败

检查 Nginx 是否正确配置了 WebSocket 代理（`Upgrade` 和 `Connection` 头）。

### Q: Exporter 远程操作失败

检查目标主机 SSH 连接是否正常，用户是否有执行权限。
