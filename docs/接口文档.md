# API 接口文档

> 完整在线文档请启动后端服务后访问：http://localhost:8080/doc.html (Knife4j)

## 基本信息

| 项目 | 值 |
|------|-----|
| Base URL | `http://localhost:8080` |
| 认证方式 | Bearer Token (JWT) |
| 请求格式 | `application/json` |
| 响应格式 | 统一 JSON 格式 |

## 认证

除登录接口外，所有接口需在请求头中携带 JWT Token：

```
Authorization: Bearer <access_token>
```

## 统一响应格式

```json
{
  "code": 200,
  "msg": "success",
  "data": {}
}
```

## 分页请求

分页接口统一使用 `pageNum` 和 `pageSize` 查询参数：

```
GET /api/prometheus/instances?pageNum=1&pageSize=10
```

分页响应：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "records": [],
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 10
  }
}
```

---

## 1. 认证模块

### 1.1 用户登录

```
POST /api/auth/login
```

请求体：
```json
{
  "username": "admin",
  "password": "admin123"
}
```

响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "accessToken": "eyJ...",
    "refreshToken": "eyJ...",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

### 1.2 获取用户信息

```
GET /api/auth/userinfo
```

### 1.3 更新个人信息

```
PUT /api/auth/profile
```

### 1.4 修改密码

```
POST /api/auth/change-password
```

### 1.5 刷新 Token

```
POST /api/auth/refresh
```

请求体：
```json
{
  "refreshToken": "eyJ..."
}
```

响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "accessToken": "eyJ...(新token)",
    "refreshToken": "eyJ...",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

### 1.6 用户登出

```
POST /api/auth/logout
```

> 清除 httpOnly Cookie 中的 access_token

---

## 2. Prometheus 实例管理

### 2.1 实例列表

```
GET /api/prometheus/instances
```

查询参数：`keyword`, `status`, `pageNum`, `pageSize`

### 2.2 创建实例

```
POST /api/prometheus/instances
```

请求体：
```json
{
  "name": "生产环境 Prometheus",
  "url": "http://10.0.0.1:9090",
  "description": "生产集群监控",
  "scrapeInterval": "15s",
  "retentionTime": "15d"
}
```

### 2.3 更新实例

```
PUT /api/prometheus/instances/{id}
```

### 2.4 删除实例

```
DELETE /api/prometheus/instances/{id}
```

### 2.5 测试连接

```
POST /api/prometheus/instances/{id}/test
```

### 2.6 读取远程配置

```
GET /api/prometheus/instances/{id}/config
```

### 2.7 推送远程配置

```
POST /api/prometheus/instances/{id}/config/push
```

---

## 3. Exporter 管理

### 3.1 Exporter 列表

```
GET /api/prometheus/exporters
```

查询参数：`keyword`, `type`, `status`, `instanceId`, `pageNum`, `pageSize`

### 3.2 创建 Exporter

```
POST /api/prometheus/exporters
```

### 3.3 批量导入 Exporter

```
POST /api/prometheus/exporters/batch
```

### 3.4 自动检测

```
POST /api/prometheus/exporters/detect
```

### 3.5 启动 / 停止 / 重启

```
POST /api/prometheus/exporters/{id}/start
POST /api/prometheus/exporters/{id}/stop
POST /api/prometheus/exporters/{id}/restart
```

### 3.6 状态检查

```
GET /api/prometheus/exporters/{id}/status
```

---

## 4. PromQL 查询

### 4.1 即时查询

```
GET /api/prometheus/query?instanceId={id}&query={promql}
```

### 4.2 范围查询

```
GET /api/prometheus/query_range?instanceId={id}&query={promql}&start={timestamp}&end={timestamp}&step={duration}
```

### 4.3 指标名称列表

```
GET /api/prometheus/labels/__name__/values?instanceId={id}
```

### 4.4 Label 值列表

```
GET /api/prometheus/labels/{label}/values?instanceId={id}
```

### 4.5 查询历史

```
GET /api/prometheus/query/history
POST /api/prometheus/query/history
```

### 4.6 PromQL 模板

```
GET /api/prometheus/query/templates
GET /api/prometheus/query/templates/tree
```

---

## 5. 仪表盘

### 5.1 仪表盘 CRUD

```
GET    /api/prometheus/dashboards
POST   /api/prometheus/dashboards
GET    /api/prometheus/dashboards/{id}
PUT    /api/prometheus/dashboards/{id}
DELETE /api/prometheus/dashboards/{id}
```

### 5.2 仪表盘模板

```
GET  /api/prometheus/dashboard/templates
GET  /api/prometheus/dashboard/templates/{id}
GET  /api/prometheus/dashboard/templates/tree
POST /api/prometheus/dashboard/templates/{id}/import
```

### 5.3 Grafana 导入/导出

导入 Grafana JSON 仪表盘：
```
POST /api/prometheus/dashboards/import
```

请求体：Grafana Dashboard JSON（支持 `{"dashboard": {...}}` 包装格式或裸 JSON）

导出为 Grafana 格式：
```
GET /api/prometheus/dashboards/{id}/export?format=grafana
```

> 不带 `format` 参数时返回内部格式

---

## 6. 告警管理

### 6.1 告警规则

```
GET    /api/prometheus/alert/rules
POST   /api/prometheus/alert/rules
PUT    /api/prometheus/alert/rules/{id}
DELETE /api/prometheus/alert/rules/{id}
POST   /api/prometheus/alert/rules/{id}/toggle
```

### 6.2 告警历史

```
GET  /api/prometheus/alert/history
POST /api/prometheus/alert/history/{id}/acknowledge
```

### 6.3 静默管理

```
GET    /api/prometheus/alert/silences
POST   /api/prometheus/alert/silences
DELETE /api/prometheus/alert/silences/{id}
```

### 6.4 通知渠道

```
GET    /api/prometheus/alert/notifications
POST   /api/prometheus/alert/notifications
PUT    /api/prometheus/alert/notifications/{id}
DELETE /api/prometheus/alert/notifications/{id}
POST   /api/prometheus/alert/notifications/{id}/test
```

### 6.5 Alertmanager Webhook

```
POST /api/prometheus/alert/webhook
```

> 接收 Alertmanager Webhook 通知，自动创建告警历史记录

---

## 7. 集群管理

```
GET    /api/prometheus/clusters
POST   /api/prometheus/clusters
GET    /api/prometheus/clusters/{id}
PUT    /api/prometheus/clusters/{id}
DELETE /api/prometheus/clusters/{id}

GET    /api/prometheus/clusters/topology
GET    /api/prometheus/clusters/health

GET    /api/prometheus/clusters/{id}/nodes
POST   /api/prometheus/clusters/{id}/nodes
DELETE /api/prometheus/clusters/{id}/nodes/{nodeId}
GET    /api/prometheus/clusters/{id}/discover
POST   /api/prometheus/clusters/{id}/sync
```

---

## 8. 权限管理

```
GET    /api/prometheus/users
POST   /api/prometheus/users
PUT    /api/prometheus/users/{id}
DELETE /api/prometheus/users/{id}
POST   /api/prometheus/users/{id}/toggle

GET    /api/prometheus/roles
POST   /api/prometheus/roles
PUT    /api/prometheus/roles/{id}
DELETE /api/prometheus/roles/{id}

GET    /api/prometheus/permissions
POST   /api/prometheus/permissions
PUT    /api/prometheus/permissions/{id}
DELETE /api/prometheus/permissions/{id}
```

---

## 9. 分布式部署

### 9.1 主机管理

```
GET    /api/prometheus/distribute/machines
POST   /api/prometheus/distribute/machines
PUT    /api/prometheus/distribute/machines/{id}
DELETE /api/prometheus/distribute/machines/{id}
POST   /api/prometheus/distribute/machines/{id}/test
POST   /api/prometheus/distribute/machines/{id}/detect
POST   /api/prometheus/distribute/machines/batch-detect
```

### 9.2 部署任务

```
POST   /api/prometheus/distribute/tasks
GET    /api/prometheus/distribute/tasks
GET    /api/prometheus/distribute/tasks/{id}
GET    /api/prometheus/distribute/tasks/{id}/details
POST   /api/prometheus/distribute/tasks/{id}/cancel
POST   /api/prometheus/distribute/tasks/{id}/details/{detailId}/retry
```

### 9.3 软件包管理

```
GET    /api/prometheus/distribute/software
POST   /api/prometheus/distribute/software/scan
POST   /api/prometheus/distribute/software/download
POST   /api/prometheus/distribute/software/upload
```

### 9.4 配置验证

```
POST /api/prometheus/distribute/prometheus/validate-config
```

---

## 10. 系统设置

```
GET /api/prometheus/settings/global
PUT /api/prometheus/settings/global

GET  /api/prometheus/settings/logs
GET  /api/prometheus/settings/logs/export
POST /api/prometheus/settings/logs/clear
```

---

## 11. 审计日志

```
GET /api/prometheus/audit-logs
```

查询参数：`username`, `action`, `startTime`, `endTime`, `pageNum`, `pageSize`

---

## 12. WebSocket

### 12.1 部署日志实时推送

```
ws://localhost:8080/ws/distribute
```

认证方式：连接后发送消息认证
```json
{"type": "auth", "token": "eyJ..."}
```

日志消息格式：
```json
{
  "taskId": "xxx",
  "machineIp": "10.0.0.1",
  "status": "running",
  "message": "正在安装 node_exporter...",
  "progress": 50
}
```

### 12.2 消息通知

```
ws://localhost:8080/ws/message
```

### 12.3 集群拓扑实时推送

```
ws://localhost:8080/ws/cluster-topology
```

认证方式：连接后发送消息认证
```json
{"type": "auth", "token": "eyJ..."}
```

订阅拓扑更新：
```json
{"type": "subscribe"}
```

接收拓扑数据：
```json
{
  "type": "topology_update",
  "data": { ... }
}
```

> 默认每 30 秒自动推送一次拓扑数据，可通过 `cluster.topology.push-interval-ms` 配置
